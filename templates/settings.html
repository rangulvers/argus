{% extends "base.html" %}

{% block title %}Settings - Argus{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block content %}
<div class="space-y-6" x-data="scheduleManager()">
    <!-- Scheduled Scans -->
    <div class="bg-white dark:bg-gray-800 shadow dark:shadow-gray-700 rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:px-6 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Scheduled Scans</h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Configure automatic network scans</p>
            </div>
            <button @click="showAddModal = true"
                    class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Add Schedule
            </button>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <!-- Jobs List -->
            <template x-if="jobs.length === 0">
                <div class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No scheduled scans</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by creating a new scheduled scan.</p>
                    <div class="mt-4">
                        <button @click="showAddModal = true"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                            Add Schedule
                        </button>
                    </div>
                </div>
            </template>

            <div class="space-y-4">
                <template x-for="job in jobs" :key="job.id">
                    <div class="border dark:border-gray-600 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- Enable/Disable Toggle -->
                                <button @click="toggleJob(job)"
                                        :class="job.enabled ? 'bg-indigo-600' : 'bg-gray-200 dark:bg-gray-600'"
                                        class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out">
                                    <span :class="job.enabled ? 'translate-x-5' : 'translate-x-0'"
                                          class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                                </button>
                                <div>
                                    <h4 class="text-sm font-medium text-gray-900 dark:text-white" x-text="job.name"></h4>
                                    <div class="flex items-center space-x-3 mt-1">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300">
                                            <svg class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <span x-text="job.cron" class="font-mono"></span>
                                        </span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                                              :class="{
                                                  'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200': job.profile === 'quick',
                                                  'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200': job.profile === 'normal',
                                                  'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200': job.profile === 'intensive'
                                              }">
                                            <span x-text="job.profile.charAt(0).toUpperCase() + job.profile.slice(1)"></span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <template x-if="job.next_run && job.enabled">
                                    <span class="text-xs text-gray-500 dark:text-gray-400">
                                        Next: <span x-text="formatDate(job.next_run)"></span>
                                    </span>
                                </template>
                                <template x-if="!job.enabled">
                                    <span class="text-xs text-gray-400 dark:text-gray-500">Disabled</span>
                                </template>
                                <button @click="editJob(job)"
                                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button @click="deleteJob(job)"
                                        class="text-gray-400 hover:text-red-600 dark:hover:text-red-400">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Message -->
            <template x-if="message">
                <div class="mt-4 p-3 rounded-md" :class="messageType === 'error' ? 'bg-red-50 dark:bg-red-900/30 text-red-800 dark:text-red-200' : 'bg-green-50 dark:bg-green-900/30 text-green-800 dark:text-green-200'">
                    <p class="text-sm" x-text="message"></p>
                </div>
            </template>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div x-show="showAddModal || showEditModal" x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="closeModal()">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-gray-500 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-75 transition-opacity" @click="closeModal()"></div>

            <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full p-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4" x-text="showEditModal ? 'Edit Schedule' : 'Add Schedule'"></h3>

                <form @submit.prevent="saveJob">
                    <!-- Name -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name</label>
                        <input type="text" x-model="form.name" required
                               class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                               placeholder="e.g., Quick Check, Weekly Deep Scan">
                    </div>

                    <!-- Schedule Presets -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Schedule</label>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button type="button" @click="form.cron = '0 */6 * * *'"
                                    :class="form.cron === '0 */6 * * *' ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/50' : 'bg-white dark:bg-gray-700'"
                                    class="px-3 py-2 border dark:border-gray-600 rounded-md text-xs font-medium text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600">
                                Every 6 hours
                            </button>
                            <button type="button" @click="form.cron = '0 */12 * * *'"
                                    :class="form.cron === '0 */12 * * *' ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/50' : 'bg-white dark:bg-gray-700'"
                                    class="px-3 py-2 border dark:border-gray-600 rounded-md text-xs font-medium text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600">
                                Every 12 hours
                            </button>
                            <button type="button" @click="form.cron = '0 2 * * *'"
                                    :class="form.cron === '0 2 * * *' ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/50' : 'bg-white dark:bg-gray-700'"
                                    class="px-3 py-2 border dark:border-gray-600 rounded-md text-xs font-medium text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600">
                                Daily (2 AM)
                            </button>
                            <button type="button" @click="form.cron = '0 2 * * 0'"
                                    :class="form.cron === '0 2 * * 0' ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/50' : 'bg-white dark:bg-gray-700'"
                                    class="px-3 py-2 border dark:border-gray-600 rounded-md text-xs font-medium text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600">
                                Weekly (Sun 2 AM)
                            </button>
                        </div>
                        <input type="text" x-model="form.cron" required
                               class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm font-mono"
                               placeholder="0 */6 * * *">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Cron format: minute hour day month weekday</p>
                    </div>

                    <!-- Scan Profile -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Scan Profile</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button type="button" @click="form.profile = 'quick'"
                                    :class="form.profile === 'quick' ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/50' : 'bg-white dark:bg-gray-700'"
                                    class="px-3 py-2 border dark:border-gray-600 rounded-md text-xs font-medium hover:bg-gray-50 dark:hover:bg-gray-600 text-left">
                                <div class="font-semibold text-gray-900 dark:text-white">Quick</div>
                                <div class="text-gray-500 dark:text-gray-400">Ping only</div>
                            </button>
                            <button type="button" @click="form.profile = 'normal'"
                                    :class="form.profile === 'normal' ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/50' : 'bg-white dark:bg-gray-700'"
                                    class="px-3 py-2 border dark:border-gray-600 rounded-md text-xs font-medium hover:bg-gray-50 dark:hover:bg-gray-600 text-left">
                                <div class="font-semibold text-gray-900 dark:text-white">Normal</div>
                                <div class="text-gray-500 dark:text-gray-400">Ports 1-1000</div>
                            </button>
                            <button type="button" @click="form.profile = 'intensive'"
                                    :class="form.profile === 'intensive' ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/50' : 'bg-white dark:bg-gray-700'"
                                    class="px-3 py-2 border dark:border-gray-600 rounded-md text-xs font-medium hover:bg-gray-50 dark:hover:bg-gray-600 text-left">
                                <div class="font-semibold text-gray-900 dark:text-white">Intensive</div>
                                <div class="text-gray-500 dark:text-gray-400">All ports + OS</div>
                            </button>
                        </div>
                    </div>

                    <!-- Enabled -->
                    <div class="mb-6 flex items-center">
                        <input type="checkbox" x-model="form.enabled" id="enabled"
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded">
                        <label for="enabled" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable this schedule</label>
                    </div>

                    <!-- Buttons -->
                    <div class="flex justify-end space-x-3">
                        <button type="button" @click="closeModal()"
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Cancel
                        </button>
                        <button type="submit"
                                :disabled="saving"
                                class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50">
                            <span x-text="saving ? 'Saving...' : (showEditModal ? 'Update' : 'Create')"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Network Configuration (Editable) -->
    <div class="bg-white dark:bg-gray-800 shadow dark:shadow-gray-700 rounded-lg overflow-hidden" x-data="configManager()">
        <div class="px-4 py-5 sm:px-6 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Network Configuration</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Configure network scanning settings</p>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <form @submit.prevent="saveConfig">
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                    <!-- Subnet -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subnet</label>
                        <input type="text" x-model="configForm.network.subnet" required
                               pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$"
                               class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm font-mono"
                               placeholder="192.168.1.0/24">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">CIDR notation (e.g., 192.168.1.0/24)</p>
                    </div>

                    <!-- Default Scan Profile -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Default Scan Profile</label>
                        <select x-model="configForm.network.scan_profile"
                                class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option value="quick">Quick (Ping only)</option>
                            <option value="normal">Normal (Ports 1-1000)</option>
                            <option value="intensive">Intensive (All ports + OS)</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Default profile for manual scans</p>
                    </div>

                    <!-- Port Range -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Port Range</label>
                        <input type="text" x-model="configForm.scanning.port_range" required
                               class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm font-mono"
                               placeholder="1-1000">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Range (e.g., 1-1000), "common", or "all"</p>
                    </div>

                    <!-- OS Detection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">OS Detection</label>
                        <div class="flex items-center mt-2">
                            <input type="checkbox" x-model="configForm.scanning.enable_os_detection" id="os-detection"
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded">
                            <label for="os-detection" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                                Enable OS detection during scans
                            </label>
                        </div>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Requires root/sudo privileges</p>
                    </div>
                </div>

                <!-- Message -->
                <template x-if="configMessage">
                    <div class="mt-4 p-3 rounded-md" :class="configMessageType === 'error' ? 'bg-red-50 dark:bg-red-900/30 text-red-800 dark:text-red-200' : 'bg-green-50 dark:bg-green-900/30 text-green-800 dark:text-green-200'">
                        <p class="text-sm" x-text="configMessage"></p>
                    </div>
                </template>

                <!-- Buttons -->
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" @click="resetConfigForm()"
                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                        Reset
                    </button>
                    <button type="submit"
                            :disabled="configSaving"
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50">
                        <span x-text="configSaving ? 'Saving...' : 'Save Configuration'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Integrations -->
    <div class="bg-white dark:bg-gray-800 shadow dark:shadow-gray-700 rounded-lg overflow-hidden" x-data="integrationsManager()">
        <div class="px-4 py-5 sm:px-6 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Integrations</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Configure external services and API access</p>
        </div>
        <div class="px-4 py-5 sm:p-6 space-y-6">
            <!-- CVE Integration -->
            <div class="border dark:border-gray-600 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0 p-2 bg-red-100 dark:bg-red-900/30 rounded-lg">
                            <svg class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-900 dark:text-white">CVE Database Integration</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                Pull vulnerability data from the NVD (National Vulnerability Database) to enrich threat assessments
                            </p>
                        </div>
                    </div>
                    <button @click="toggleCVE()"
                            :class="cveEnabled ? 'bg-indigo-600' : 'bg-gray-200 dark:bg-gray-600'"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        <span :class="cveEnabled ? 'translate-x-5' : 'translate-x-0'"
                              class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                    </button>
                </div>

                <!-- CVE Settings (shown when enabled) -->
                <div x-show="cveEnabled" x-collapse class="mt-4 pt-4 border-t dark:border-gray-600">
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">NVD API Key (Optional)</label>
                            <input type="password" x-model="cveApiKey"
                                   class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                   placeholder="Enter API key for higher rate limits">
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                Get a free API key from <a href="https://nvd.nist.gov/developers/request-an-api-key" target="_blank" class="text-indigo-600 dark:text-indigo-400 hover:underline">NVD</a> for faster lookups
                            </p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cache Duration (hours)</label>
                            <input type="number" x-model.number="cveCacheHours" min="1" max="168"
                                   class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">How long to cache CVE data locally</p>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button @click="saveCVESettings()" :disabled="cveSaving"
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50">
                            <span x-text="cveSaving ? 'Saving...' : 'Save CVE Settings'"></span>
                        </button>
                    </div>
                </div>

                <!-- CVE Message -->
                <template x-if="cveMessage">
                    <div class="mt-4 p-3 rounded-md" :class="cveMessageType === 'error' ? 'bg-red-50 dark:bg-red-900/30 text-red-800 dark:text-red-200' : 'bg-green-50 dark:bg-green-900/30 text-green-800 dark:text-green-200'">
                        <p class="text-sm" x-text="cveMessage"></p>
                    </div>
                </template>
            </div>

            <!-- API Keys Integration -->
            <div class="border dark:border-gray-600 rounded-lg p-4" x-data="apiKeyManager()">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0 p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg">
                            <svg class="h-6 w-6 text-indigo-600 dark:text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-900 dark:text-white">API Keys</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                Manage API keys for programmatic access to Argus
                            </p>
                        </div>
                    </div>
                    <button @click="showCreateModal = true"
                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                        <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Create Key
                    </button>
                </div>

                <div class="mt-4 pt-4 border-t dark:border-gray-600">
                    <template x-if="keys.length === 0">
                        <div class="text-center py-6">
                            <p class="text-sm text-gray-500 dark:text-gray-400">No API keys created yet.</p>
                        </div>
                    </template>

                    <div class="space-y-3">
                        <template x-for="key in keys" :key="key.id">
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg" :class="key.is_revoked ? 'opacity-60' : ''">
                                <div class="flex items-center space-x-3 min-w-0">
                                    <div class="min-w-0">
                                        <h5 class="text-sm font-medium text-gray-900 dark:text-white truncate" x-text="key.name"></h5>
                                        <div class="flex items-center space-x-2 mt-0.5">
                                            <span class="text-xs font-mono text-gray-500 dark:text-gray-400" x-text="key.key_prefix + '...'"></span>
                                            <template x-if="key.is_revoked">
                                                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200">Revoked</span>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                                <template x-if="!key.is_revoked">
                                    <button @click="revokeKey(key)"
                                            class="text-xs text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300">
                                        Revoke
                                    </button>
                                </template>
                            </div>
                        </template>
                    </div>

                    <!-- Message -->
                    <template x-if="message">
                        <div class="mt-3 p-3 rounded-md" :class="messageType === 'error' ? 'bg-red-50 dark:bg-red-900/30 text-red-800 dark:text-red-200' : 'bg-green-50 dark:bg-green-900/30 text-green-800 dark:text-green-200'">
                            <p class="text-sm" x-text="message"></p>
                        </div>
                    </template>

                    <!-- New Key Display -->
                    <template x-if="newKey">
                        <div class="mt-3 p-3 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700 rounded-lg">
                            <div class="flex items-start">
                                <svg class="h-5 w-5 text-yellow-600 dark:text-yellow-400 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <div class="ml-3 flex-1 min-w-0">
                                    <p class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Save your API key now!</p>
                                    <div class="mt-2 flex items-center space-x-2">
                                        <code class="flex-1 px-2 py-1 bg-white dark:bg-gray-800 border border-yellow-300 dark:border-yellow-600 rounded text-xs font-mono text-gray-900 dark:text-white break-all" x-text="newKey"></code>
                                        <button @click="copyKey()" class="p-1 text-yellow-700 dark:text-yellow-300 hover:bg-yellow-100 dark:hover:bg-yellow-900/50 rounded">
                                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <button @click="newKey = null" class="mt-2 text-xs text-yellow-600 dark:text-yellow-400 hover:underline">Dismiss</button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Create API Key Modal -->
                <div x-show="showCreateModal" x-cloak
                     class="fixed inset-0 z-50 overflow-y-auto"
                     @keydown.escape.window="showCreateModal = false">
                    <div class="flex items-center justify-center min-h-screen px-4">
                        <div class="fixed inset-0 bg-gray-500 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-75 transition-opacity" @click="showCreateModal = false"></div>

                        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full p-6">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Create API Key</h3>

                            <form @submit.prevent="createKey">
                                <!-- Name -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name</label>
                                    <input type="text" x-model="createForm.name" required
                                           class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                                           placeholder="e.g., Homepage Widget, CLI Access">
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">A descriptive name to identify this key</p>
                                </div>

                                <!-- Expiration -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Expiration</label>
                                    <div class="grid grid-cols-4 gap-2">
                                        <button type="button" @click="createForm.expires_in_days = null"
                                                :class="createForm.expires_in_days === null ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/50' : 'bg-white dark:bg-gray-700'"
                                                class="px-3 py-2 border dark:border-gray-600 rounded-md text-xs font-medium text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600">
                                            Never
                                        </button>
                                        <button type="button" @click="createForm.expires_in_days = 30"
                                                :class="createForm.expires_in_days === 30 ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/50' : 'bg-white dark:bg-gray-700'"
                                                class="px-3 py-2 border dark:border-gray-600 rounded-md text-xs font-medium text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600">
                                            30 days
                                        </button>
                                        <button type="button" @click="createForm.expires_in_days = 90"
                                                :class="createForm.expires_in_days === 90 ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/50' : 'bg-white dark:bg-gray-700'"
                                                class="px-3 py-2 border dark:border-gray-600 rounded-md text-xs font-medium text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600">
                                            90 days
                                        </button>
                                        <button type="button" @click="createForm.expires_in_days = 365"
                                                :class="createForm.expires_in_days === 365 ? 'ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/50' : 'bg-white dark:bg-gray-700'"
                                                class="px-3 py-2 border dark:border-gray-600 rounded-md text-xs font-medium text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600">
                                            1 year
                                        </button>
                                    </div>
                                </div>

                                <!-- Buttons -->
                                <div class="flex justify-end space-x-3">
                                    <button type="button" @click="showCreateModal = false"
                                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                                        Cancel
                                    </button>
                                    <button type="submit"
                                            :disabled="creating"
                                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50">
                                        <span x-text="creating ? 'Creating...' : 'Create Key'"></span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Log -->
    <div class="bg-white dark:bg-gray-800 shadow dark:shadow-gray-700 rounded-lg overflow-hidden" x-data="auditLogViewer()">
        <div class="px-4 py-5 sm:px-6 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Audit Log</h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Recent security and activity events</p>
            </div>
            <button @click="loadLogs()" :disabled="loading"
                    class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600">
                <svg class="h-4 w-4 mr-1.5" :class="loading ? 'animate-spin' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Refresh
            </button>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <!-- Filter -->
            <div class="mb-4 flex items-center space-x-4">
                <select x-model="filter.action" @change="loadLogs()"
                        class="rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">All Actions</option>
                    <option value="login_success">Login Success</option>
                    <option value="login_failed">Login Failed</option>
                    <option value="logout">Logout</option>
                    <option value="scan_started">Scan Started</option>
                    <option value="device_updated">Device Updated</option>
                    <option value="api_key_created">API Key Created</option>
                    <option value="api_key_revoked">API Key Revoked</option>
                    <option value="config_updated">Config Updated</option>
                </select>
                <span class="text-sm text-gray-500 dark:text-gray-400" x-text="logs.length + ' entries'"></span>
            </div>

            <!-- Logs Table -->
            <template x-if="logs.length === 0 && !loading">
                <div class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No audit logs</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Activity will be logged here.</p>
                </div>
            </template>

            <template x-if="loading">
                <div class="text-center py-8">
                    <svg class="animate-spin mx-auto h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Loading audit logs...</p>
                </div>
            </template>

            <template x-if="logs.length > 0 && !loading">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead>
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Time</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">User</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Action</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Details</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">IP</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            <template x-for="log in logs" :key="log.id">
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400 whitespace-nowrap" x-text="formatDate(log.timestamp)"></td>
                                    <td class="px-3 py-2 text-sm text-gray-900 dark:text-white" x-text="log.username || 'System'"></td>
                                    <td class="px-3 py-2">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                                              :class="getActionClass(log.action, log.success)">
                                            <span x-text="formatAction(log.action)"></span>
                                        </span>
                                    </td>
                                    <td class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400 max-w-xs truncate" x-text="formatDetails(log)"></td>
                                    <td class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400 font-mono text-xs" x-text="log.ip_address || '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </template>

            <!-- Load More -->
            <template x-if="logs.length >= 50">
                <div class="mt-4 text-center">
                    <button @click="loadMore()" :disabled="loadingMore"
                            class="text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300">
                        <span x-text="loadingMore ? 'Loading...' : 'Load more'"></span>
                    </button>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
function integrationsManager() {
    return {
        cveEnabled: {{ 'true' if config.integrations.cve.enabled else 'false' }},
        cveApiKey: '{{ config.integrations.cve.api_key or "" }}',
        cveCacheHours: {{ config.integrations.cve.cache_hours }},
        cveSaving: false,
        cveMessage: '',
        cveMessageType: '',

        async toggleCVE() {
            this.cveEnabled = !this.cveEnabled;
            await this.saveCVESettings();
        },

        async saveCVESettings() {
            this.cveSaving = true;
            this.cveMessage = '';

            try {
                const response = await fetch('/api/integrations/cve', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        enabled: this.cveEnabled,
                        api_key: this.cveApiKey || null,
                        cache_hours: this.cveCacheHours
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    this.showCVEMessage('CVE integration settings saved', 'success');
                } else {
                    this.showCVEMessage(data.detail || 'Failed to save settings', 'error');
                    // Revert toggle if save failed
                    this.cveEnabled = !this.cveEnabled;
                }
            } catch (error) {
                this.showCVEMessage('Failed to save settings: ' + error.message, 'error');
                this.cveEnabled = !this.cveEnabled;
            }

            this.cveSaving = false;
        },

        showCVEMessage(msg, type) {
            this.cveMessage = msg;
            this.cveMessageType = type;
            setTimeout(() => { this.cveMessage = ''; }, 5000);
        }
    }
}

function auditLogViewer() {
    return {
        logs: [],
        loading: true,
        loadingMore: false,
        filter: {
            action: ''
        },
        offset: 0,

        init() {
            this.loadLogs();
        },

        async loadLogs() {
            this.loading = true;
            this.offset = 0;
            let url = '/api/audit-logs?limit=50';
            if (this.filter.action) {
                url += '&action=' + this.filter.action;
            }

            try {
                const response = await fetch(url);
                this.logs = await response.json();
            } catch (error) {
                console.error('Failed to load audit logs:', error);
            }

            this.loading = false;
        },

        async loadMore() {
            this.loadingMore = true;
            this.offset += 50;
            let url = '/api/audit-logs?limit=50&offset=' + this.offset;
            if (this.filter.action) {
                url += '&action=' + this.filter.action;
            }

            try {
                const response = await fetch(url);
                const moreLogs = await response.json();
                this.logs = [...this.logs, ...moreLogs];
            } catch (error) {
                console.error('Failed to load more audit logs:', error);
            }

            this.loadingMore = false;
        },

        formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        },

        formatAction(action) {
            const labels = {
                'login_success': 'Login',
                'login_failed': 'Login Failed',
                'logout': 'Logout',
                'setup_complete': 'Setup',
                'api_key_created': 'Key Created',
                'api_key_revoked': 'Key Revoked',
                'scan_started': 'Scan Started',
                'scan_completed': 'Scan Done',
                'scan_failed': 'Scan Failed',
                'device_updated': 'Device Updated',
                'config_updated': 'Config Updated'
            };
            return labels[action] || action;
        },

        getActionClass(action, success) {
            if (!success) return 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';

            const classes = {
                'login_success': 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200',
                'login_failed': 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200',
                'logout': 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200',
                'scan_started': 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200',
                'scan_completed': 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200',
                'device_updated': 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200',
                'api_key_created': 'bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200',
                'api_key_revoked': 'bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200',
                'config_updated': 'bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200',
            };
            return classes[action] || 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200';
        },

        formatDetails(log) {
            if (!log.details) return '-';
            if (log.resource_type === 'scan') {
                return `${log.details.subnet || ''} (${log.details.profile || ''})`;
            }
            if (log.resource_type === 'device') {
                return log.details.ip_address || '';
            }
            if (log.resource_type === 'api_key') {
                return log.details.name || '';
            }
            if (log.action === 'login_failed') {
                return log.details.reason || '';
            }
            return JSON.stringify(log.details).substring(0, 50);
        }
    }
}

function apiKeyManager() {
    return {
        keys: {{ api_keys | tojson if api_keys else '[]' | safe }},
        showCreateModal: false,
        createForm: {
            name: '',
            expires_in_days: null
        },
        creating: false,
        message: '',
        messageType: '',
        newKey: null,

        formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        },

        isExpired(isoString) {
            if (!isoString) return false;
            return new Date(isoString) < new Date();
        },

        async createKey() {
            this.creating = true;
            this.message = '';

            try {
                const response = await fetch('/api/keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.createForm)
                });

                const data = await response.json();

                if (response.ok) {
                    this.newKey = data.key;
                    this.keys.unshift({
                        id: data.id,
                        name: data.name,
                        key_prefix: data.key_prefix,
                        created_at: data.created_at,
                        last_used_at: null,
                        expires_at: data.expires_at,
                        is_revoked: false
                    });
                    this.showCreateModal = false;
                    this.createForm = { name: '', expires_in_days: null };
                } else {
                    this.showMessage(data.detail || 'Failed to create API key', 'error');
                }
            } catch (error) {
                this.showMessage('Failed to create API key: ' + error.message, 'error');
            }

            this.creating = false;
        },

        async revokeKey(key) {
            if (!confirm(`Revoke API key "${key.name}"? This cannot be undone.`)) return;

            try {
                const response = await fetch(`/api/keys/${key.id}`, { method: 'DELETE' });

                if (response.ok) {
                    const index = this.keys.findIndex(k => k.id === key.id);
                    if (index !== -1) {
                        this.keys[index].is_revoked = true;
                    }
                    this.showMessage('API key revoked', 'success');
                } else {
                    const data = await response.json();
                    this.showMessage(data.detail || 'Failed to revoke API key', 'error');
                }
            } catch (error) {
                this.showMessage('Failed to revoke API key: ' + error.message, 'error');
            }
        },

        copyKey() {
            navigator.clipboard.writeText(this.newKey).then(() => {
                this.showMessage('API key copied to clipboard', 'success');
            });
        },

        showMessage(msg, type) {
            this.message = msg;
            this.messageType = type;
            setTimeout(() => { this.message = ''; }, 5000);
        }
    }
}

function scheduleManager() {
    return {
        jobs: {{ schedules | tojson }},
        showAddModal: false,
        showEditModal: false,
        editingId: null,
        form: {
            name: '',
            cron: '0 2 * * 0',
            profile: 'normal',
            enabled: true
        },
        saving: false,
        message: '',
        messageType: '',

        formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleString();
        },

        resetForm() {
            this.form = {
                name: '',
                cron: '0 2 * * 0',
                profile: 'normal',
                enabled: true
            };
            this.editingId = null;
        },

        closeModal() {
            this.showAddModal = false;
            this.showEditModal = false;
            this.resetForm();
        },

        editJob(job) {
            this.form = {
                name: job.name,
                cron: job.cron,
                profile: job.profile,
                enabled: job.enabled
            };
            this.editingId = job.id;
            this.showEditModal = true;
        },

        async toggleJob(job) {
            try {
                const response = await fetch(`/api/schedule/${job.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...job,
                        enabled: !job.enabled
                    })
                });
                const data = await response.json();
                const index = this.jobs.findIndex(j => j.id === job.id);
                if (index !== -1) {
                    this.jobs[index] = data;
                }
            } catch (error) {
                this.showMessage('Failed to update job', 'error');
            }
        },

        async deleteJob(job) {
            if (!confirm(`Delete schedule "${job.name}"?`)) return;

            try {
                await fetch(`/api/schedule/${job.id}`, { method: 'DELETE' });
                this.jobs = this.jobs.filter(j => j.id !== job.id);
                this.showMessage('Schedule deleted', 'success');
            } catch (error) {
                this.showMessage('Failed to delete schedule', 'error');
            }
        },

        async saveJob() {
            this.saving = true;

            try {
                let response;
                if (this.showEditModal) {
                    response = await fetch(`/api/schedule/${this.editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.form)
                    });
                } else {
                    response = await fetch('/api/schedule', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.form)
                    });
                }

                const data = await response.json();

                if (this.showEditModal) {
                    const index = this.jobs.findIndex(j => j.id === this.editingId);
                    if (index !== -1) {
                        this.jobs[index] = data;
                    }
                    this.showMessage('Schedule updated', 'success');
                } else {
                    this.jobs.push(data);
                    this.showMessage('Schedule created', 'success');
                }

                this.closeModal();
            } catch (error) {
                this.showMessage('Failed to save schedule', 'error');
            }

            this.saving = false;
        },

        showMessage(msg, type) {
            this.message = msg;
            this.messageType = type;
            setTimeout(() => { this.message = ''; }, 3000);
        }
    }
}

function configManager() {
    return {
        configForm: {
            network: {
                subnet: '{{ config.network.subnet }}',
                scan_profile: '{{ config.network.scan_profile }}'
            },
            scanning: {
                port_range: '{{ config.scanning.port_range }}',
                enable_os_detection: {{ 'true' if config.scanning.enable_os_detection else 'false' }}
            }
        },
        originalConfig: null,
        configSaving: false,
        configMessage: '',
        configMessageType: '',

        init() {
            // Store original config for reset
            this.originalConfig = JSON.parse(JSON.stringify(this.configForm));
        },

        resetConfigForm() {
            this.configForm = JSON.parse(JSON.stringify(this.originalConfig));
            this.configMessage = '';
        },

        async saveConfig() {
            this.configSaving = true;
            this.configMessage = '';

            try {
                const response = await fetch('/api/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.configForm)
                });

                const data = await response.json();

                if (response.ok) {
                    this.showConfigMessage('Configuration saved successfully', 'success');
                    // Update original config after successful save
                    this.originalConfig = JSON.parse(JSON.stringify(this.configForm));
                } else {
                    this.showConfigMessage(data.detail || 'Failed to save configuration', 'error');
                }
            } catch (error) {
                this.showConfigMessage('Failed to save configuration: ' + error.message, 'error');
            }

            this.configSaving = false;
        },

        showConfigMessage(msg, type) {
            this.configMessage = msg;
            this.configMessageType = type;
            setTimeout(() => { this.configMessage = ''; }, 5000);
        }
    }
}
</script>
{% endblock %}
